"""
æœŸè´§/ETF/æŒ‡æ•° Ticker â†’ ä¸­æ–‡åç§° æ˜ å°„è¡¨åŠè§£æé€»è¾‘ã€‚
åªéœ€ç»´æŠ¤åˆçº¦å‰ç¼€ï¼ˆå¦‚ AGã€ESã€GCï¼‰ï¼Œç¨‹åºè‡ªåŠ¨è¯†åˆ«æœˆä»½/å¹´ä»½å˜åŒ–ã€‚
"""
import re
import pandas as pd

# â”€â”€ æ¿å—åˆ†ç±» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SECTOR_ORDER = [
    "è´µé‡‘å±", "æœ‰è‰²é‡‘å±", "ç„¦ç…¤é’¢çŸ¿", "éé‡‘å±å»ºæ", "èƒ½æº", "åŒ–å·¥",
    "æ²¹è„‚æ²¹æ–™", "è½¯å•†å“", "å†œå‰¯äº§å“", "è°·ç‰©", "èˆªè¿", "è‚¡", "å€º", "å…¶ä»–"
]

SECTOR_ICONS = {
    "è´µé‡‘å±": "ğŸ¥‡", "æœ‰è‰²é‡‘å±": "ğŸ”©", "ç„¦ç…¤é’¢çŸ¿": "â›ï¸", "éé‡‘å±å»ºæ": "ğŸ§±",
    "èƒ½æº": "â›½", "åŒ–å·¥": "ğŸ§ª", "æ²¹è„‚æ²¹æ–™": "ğŸ«’", "è½¯å•†å“": "ğŸ¬",
    "å†œå‰¯äº§å“": "ğŸ·", "è°·ç‰©": "ğŸŒ¾", "èˆªè¿": "ğŸš¢", "è‚¡": "ğŸ“ˆ", "å€º": "ğŸ’°", "å…¶ä»–": "ğŸ“¦"
}

# åˆçº¦å‰ç¼€ â†’ æ¿å—
SECTOR_MAP = {
    # è´µé‡‘å±
    "AG": "è´µé‡‘å±", "AU": "è´µé‡‘å±", "GC": "è´µé‡‘å±", "SI": "è´µé‡‘å±",
    # æœ‰è‰²é‡‘å±
    "CU": "æœ‰è‰²é‡‘å±", "NI": "æœ‰è‰²é‡‘å±", "ZN": "æœ‰è‰²é‡‘å±", "AL": "æœ‰è‰²é‡‘å±",
    "PB": "æœ‰è‰²é‡‘å±", "SN": "æœ‰è‰²é‡‘å±", "SS": "æœ‰è‰²é‡‘å±", "BC": "æœ‰è‰²é‡‘å±", "HG": "æœ‰è‰²é‡‘å±",
    # ç„¦ç…¤é’¢çŸ¿
    "HC": "ç„¦ç…¤é’¢çŸ¿", "RB": "ç„¦ç…¤é’¢çŸ¿", "I": "ç„¦ç…¤é’¢çŸ¿", "J": "ç„¦ç…¤é’¢çŸ¿", "JM": "ç„¦ç…¤é’¢çŸ¿",
    "SF": "ç„¦ç…¤é’¢çŸ¿", "SM": "ç„¦ç…¤é’¢çŸ¿",
    # éé‡‘å±å»ºæ
    "FG": "éé‡‘å±å»ºæ", "SA": "éé‡‘å±å»ºæ",
    # èƒ½æº
    "SC": "èƒ½æº", "LU": "èƒ½æº", "NR": "èƒ½æº", "BU": "èƒ½æº", "RU": "èƒ½æº", "FU": "èƒ½æº",
    "CO": "èƒ½æº", "CL": "èƒ½æº", "PG": "èƒ½æº", "ZC": "èƒ½æº",
    # åŒ–å·¥
    "EG": "åŒ–å·¥", "L": "åŒ–å·¥", "PP": "åŒ–å·¥", "EB": "åŒ–å·¥", "V": "åŒ–å·¥",
    "MA": "åŒ–å·¥", "TA": "åŒ–å·¥", "PF": "åŒ–å·¥", "UR": "åŒ–å·¥", "SP": "åŒ–å·¥",
    # æ²¹è„‚æ²¹æ–™
    "M": "æ²¹è„‚æ²¹æ–™", "P": "æ²¹è„‚æ²¹æ–™", "Y": "æ²¹è„‚æ²¹æ–™", "OI": "æ²¹è„‚æ²¹æ–™",
    "RM": "æ²¹è„‚æ²¹æ–™", "PK": "æ²¹è„‚æ²¹æ–™",
    # è½¯å•†å“
    "CF": "è½¯å•†å“", "SR": "è½¯å•†å“", "AP": "è½¯å•†å“", "CJ": "è½¯å•†å“", "CY": "è½¯å•†å“",
    # å†œå‰¯äº§å“
    "JD": "å†œå‰¯äº§å“", "LH": "å†œå‰¯äº§å“",
    # è°·ç‰©
    "C": "è°·ç‰©", "A": "è°·ç‰©", "B": "è°·ç‰©", "CS": "è°·ç‰©", "RR": "è°·ç‰©",
    # è‚¡æŒ‡æœŸè´§ - å¢ƒå†…
    "IC": "è‚¡", "IF": "è‚¡", "IM": "è‚¡", "IH": "è‚¡",
    # å€ºåˆ¸æœŸè´§ - å¢ƒå†…
    "T": "å€º", "TF": "å€º", "TL": "å€º", "TS": "å€º",
    # è‚¡æŒ‡æœŸè´§ - æ¸¯è‚¡
    "HSIF": "è‚¡", "HHIF": "è‚¡", "HTIF": "è‚¡",
    # é‡‘èæœŸè´§ - Eurex
    "FDAX": "è‚¡", "FGBL": "å€º",
    # è‚¡æŒ‡æœŸè´§ - å¢ƒå¤–
    "ES": "è‚¡", "NQ": "è‚¡", "DM": "è‚¡", "NK": "è‚¡", "NO": "è‚¡",
    # å€ºåˆ¸æœŸè´§ - å¢ƒå¤–
    "FV": "å€º", "TY": "å€º", "TU": "å€º", "US": "å€º", "JB": "å€º",
}

# â”€â”€ æœŸè´§åˆçº¦å‰ç¼€ â†’ ä¸­æ–‡åç§° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FUTURES_NAME_MAP = {
    # â”€â”€ ä¸ŠæœŸæ‰€ (.SHF) â”€â”€
    "AG": "ç™½é“¶æœŸè´§", "AU": "é»„é‡‘æœŸè´§", "CU": "é“œæœŸè´§",
    "HC": "çƒ­è½§å·æ¿", "NI": "é•æœŸè´§", "RB": "èºçº¹é’¢",
    "SP": "çº¸æµ†æœŸè´§", "ZN": "é”ŒæœŸè´§", "AL": "é“æœŸè´§",
    "PB": "é“…æœŸè´§", "SN": "é”¡æœŸè´§", "SS": "ä¸é”ˆé’¢",
    "BU": "æ²¥é’æœŸè´§", "RU": "æ©¡èƒ¶æœŸè´§", "FU": "ç‡ƒæ–™æ²¹",
    # â”€â”€ ä¸ŠæœŸèƒ½æº (.INE) â”€â”€
    "SC": "åŸæ²¹æœŸè´§", "LU": "ä½ç¡«ç‡ƒæ–™æ²¹", "NR": "20å·èƒ¶", "BC": "å›½é™…é“œ",
    # â”€â”€ å¤§å•†æ‰€ (.DCE) â”€â”€
    "I": "é“çŸ¿çŸ³", "M": "è±†ç²•æœŸè´§", "C": "ç‰ç±³æœŸè´§",
    "EG": "ä¹™äºŒé†‡", "J": "ç„¦ç‚­æœŸè´§", "JM": "ç„¦ç…¤æœŸè´§",
    "L": "èšä¹™çƒ¯(å¡‘æ–™)", "P": "æ£•æ¦ˆæ²¹", "PP": "èšä¸™çƒ¯",
    "Y": "è±†æ²¹æœŸè´§", "A": "è±†ä¸€æœŸè´§", "B": "è±†äºŒæœŸè´§",
    "CS": "æ·€ç²‰æœŸè´§", "EB": "è‹¯ä¹™çƒ¯", "JD": "é¸¡è›‹æœŸè´§",
    "LH": "ç”ŸçŒªæœŸè´§", "PG": "æ¶²åŒ–çŸ³æ²¹æ°”", "RR": "ç²³ç±³æœŸè´§", "V": "PVCæœŸè´§",
    # â”€â”€ éƒ‘å•†æ‰€ (.CZC) â”€â”€
    "CF": "æ£‰èŠ±æœŸè´§", "FG": "ç»ç’ƒæœŸè´§", "MA": "ç”²é†‡æœŸè´§",
    "OI": "èœæ²¹æœŸè´§", "RM": "èœç²•æœŸè´§", "SA": "çº¯ç¢±æœŸè´§",
    "SR": "ç™½ç³–æœŸè´§", "TA": "PTAæœŸè´§", "AP": "è‹¹æœæœŸè´§",
    "CJ": "çº¢æ£æœŸè´§", "CY": "æ£‰çº±æœŸè´§", "PF": "çŸ­çº¤æœŸè´§",
    "PK": "èŠ±ç”ŸæœŸè´§", "SF": "ç¡…é“æœŸè´§", "SM": "é”°ç¡…æœŸè´§",
    "UR": "å°¿ç´ æœŸè´§", "ZC": "åŠ¨åŠ›ç…¤",
    # â”€â”€ ä¸­é‡‘æ‰€ (.CFE) â”€â”€
    "IC": "ä¸­è¯500è‚¡æŒ‡", "IF": "æ²ªæ·±300è‚¡æŒ‡",
    "IM": "ä¸­è¯1000è‚¡æŒ‡", "IH": "ä¸Šè¯50è‚¡æŒ‡",
    "T": "10Yå›½å€ºæœŸè´§", "TF": "5Yå›½å€ºæœŸè´§",
    "TL": "30Yå›½å€ºæœŸè´§", "TS": "2Yå›½å€ºæœŸè´§",
    # â”€â”€ æ¸¯è‚¡æœŸè´§ (.HK) â”€â”€
    "HSIF": "æ’ç”ŸæŒ‡æ•°æœŸè´§", "HHIF": "æ’ç”Ÿå›½ä¼æŒ‡æ•°æœŸè´§", "HTIF": "æ’ç”Ÿç§‘æŠ€æŒ‡æ•°æœŸè´§",
    # â”€â”€ Eurex â”€â”€
    "FDAX": "DAXæŒ‡æ•°æœŸè´§", "FGBL": "å¾·å›½å›½å€ºæœŸè´§",
    # â”€â”€ Bloomberg å¢ƒå¤–æŒ‡æ•° (Index) â”€â”€
    "ES": "æ ‡æ™®500æœŸè´§", "NQ": "çº³æŒ‡100æœŸè´§",
    "DM": "é“æŒ‡è¿·ä½ æœŸè´§", "NK": "æ—¥ç»225æœŸè´§(SGX)",
    "NO": "æ—¥ç»225è¿·ä½ (OSE)",
    # â”€â”€ Bloomberg å¢ƒå¤–å•†å“/å€ºåˆ¸ (Comdty) â”€â”€
    "CO": "å¸ƒä¼¦ç‰¹åŸæ²¹", "GC": "COMEXé»„é‡‘",
    "HG": "COMEXé“œ", "SI": "COMEXç™½é“¶", "CL": "WTIåŸæ²¹",
    "FV": "ç¾å›½5Yå›½å€º", "TY": "ç¾å›½10Yå›½å€º",
    "TU": "ç¾å›½2Yå›½å€º", "US": "ç¾å›½30Yå›½å€º",
    "JB": "æ—¥æœ¬å›½å€º(JGB)",
}

# â”€â”€ ETF / æŒ‡æ•°ä»£ç  â†’ ä¸­æ–‡åç§° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ETF_NAME_MAP = {
    "159915.SZ": "åˆ›ä¸šæ¿ETF", "588000.SH": "ç§‘åˆ›50ETF",
    "511380.SH": "å¯è½¬å€ºETF", "512890.SH": "çº¢åˆ©ä½æ³¢ETF",
    "000688.SH": "ç§‘åˆ›50æŒ‡æ•°", "SZ399006": "åˆ›ä¸šæ¿æŒ‡",
}

# â”€â”€ ç‰¹æ®ŠæŒ‡æ•°ä»£ç ï¼ˆæ— æœˆä»½ç ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SPECIAL_INDEX_MAP = {
    "SPX": "æ ‡æ™®500æŒ‡æ•°", "NDX": "çº³æŒ‡100æŒ‡æ•°", "RTY": "ç½—ç´ 2000æŒ‡æ•°",
}

# Bloomberg æœˆä»½ä»£ç : F=1æœˆ G=2æœˆ H=3æœˆ J=4æœˆ K=5æœˆ M=6æœˆ
#                     N=7æœˆ Q=8æœˆ U=9æœˆ V=10æœˆ X=11æœˆ Z=12æœˆ
_BBG_MONTH_CODES = set("FGHJKMNQUVXZ")


# â”€â”€ è§£æå‡½æ•° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def resolve_ticker_name(ticker_str):
    """ä» Wind Ticker æˆ–æ ‡çš„ç‰©ä»£ç è§£æå‡ºä¸­æ–‡åç§°ã€‚

    è§„åˆ™:
      å¢ƒå†…: AG2606.SHF â†’ AG â†’ ç™½é“¶æœŸè´§
            CF605.CZC  â†’ CF â†’ æ£‰èŠ±æœŸè´§
            HSIF2602.HK â†’ HSIF â†’ æ’ç”ŸæŒ‡æ•°æœŸè´§
            FDAX2603    â†’ FDAX â†’ DAXæŒ‡æ•°æœŸè´§
      å¢ƒå¤–: ESH6 Index  â†’ ES â†’ æ ‡æ™®500æœŸè´§
            GCJ6 Comdty â†’ GC â†’ COMEXé»„é‡‘
    """
    if pd.isna(ticker_str):
        return None
    ticker = str(ticker_str).strip()
    if not ticker:
        return None

    # 1) ETF / æŒ‡æ•°ç²¾ç¡®åŒ¹é…
    if ticker in ETF_NAME_MAP:
        return ETF_NAME_MAP[ticker]

    # 2) å¢ƒå†…æœŸè´§: XX2606.SHF / XX605.CZC / XX2602.CFE / XX2604.INE
    m = re.match(r'^([A-Za-z]+)\d+\.(SHF|DCE|CZC|INE|CFE)$', ticker)
    if m:
        return FUTURES_NAME_MAP.get(m.group(1).upper())

    # 3) æ¸¯è‚¡æœŸè´§: HHIF2602.HK
    m = re.match(r'^([A-Za-z]+)\d+\.HK$', ticker)
    if m:
        return FUTURES_NAME_MAP.get(m.group(1).upper())

    # 4) Eurex: FDAX2603, FGBL2603 (çº¯å­—æ¯+æ•°å­—, æ— äº¤æ˜“æ‰€åç¼€)
    m = re.match(r'^([A-Za-z]{2,})\d{4}$', ticker)
    if m:
        return FUTURES_NAME_MAP.get(m.group(1).upper())

    # 5) Bloomberg: ESH6 Index / GCJ6 Comdty (å‰ç¼€ + æœˆä»½ç  + å¹´ä»½ + ç±»å‹)
    m = re.match(r'^([A-Za-z]+?)([FGHJKMNQUVXZ])(\d{1,2})\s+(Index|Comdty)$', ticker)
    if m and m.group(2) in _BBG_MONTH_CODES:
        return FUTURES_NAME_MAP.get(m.group(1).upper())

    # 6) ç®€å•æŒ‡æ•°ä»£ç : SPX Index
    if ticker.endswith(" Index"):
        code = ticker.replace(" Index", "").strip().upper()
        return SPECIAL_INDEX_MAP.get(code)

    return None


def populate_names(df):
    """ä¸º åç§° åˆ—ä¸ºç©ºæˆ– '-' çš„è¡Œ, æ ¹æ® Wind Ticker / æ ‡çš„ç‰© è‡ªåŠ¨å¡«å……ä¸­æ–‡åç§°ã€‚"""
    for i, row in df.iterrows():
        current = row.get("åç§°")
        if pd.isna(current) or str(current).strip() in ("", "-"):
            name = resolve_ticker_name(row.get("Wind Ticker"))
            if name is None:
                name = resolve_ticker_name(row.get("æ ‡çš„ç‰©"))
            if name:
                df.at[i, "åç§°"] = name


def _extract_prefix(ticker_str):
    """ä» Ticker å­—ç¬¦ä¸²æå–åˆçº¦å‰ç¼€ç”¨äºæ¿å—åˆ†ç±»ã€‚"""
    if pd.isna(ticker_str):
        return None
    ticker = str(ticker_str).strip()
    if not ticker:
        return None

    # 1) ETF / æŒ‡æ•°ç²¾ç¡®åŒ¹é… - å½’ç±»ä¸ºé‡‘èæœŸè´§
    if ticker in ETF_NAME_MAP:
        return None  # ETF ä¸åˆ†ç±»

    # 2) å¢ƒå†…æœŸè´§: XX2606.SHF / XX605.CZC / XX2602.CFE / XX2604.INE
    m = re.match(r'^([A-Za-z]+)\d+\.(SHF|DCE|CZC|INE|CFE)$', ticker)
    if m:
        return m.group(1).upper()

    # 3) æ¸¯è‚¡æœŸè´§: HHIF2602.HK
    m = re.match(r'^([A-Za-z]+)\d+\.HK$', ticker)
    if m:
        return m.group(1).upper()

    # 4) Eurex: FDAX2603, FGBL2603 (çº¯å­—æ¯+æ•°å­—, æ— äº¤æ˜“æ‰€åç¼€)
    m = re.match(r'^([A-Za-z]{2,})\d{4}$', ticker)
    if m:
        return m.group(1).upper()

    # 5) Bloomberg: ESH6 Index / GCJ6 Comdty (å‰ç¼€ + æœˆä»½ç  + å¹´ä»½ + ç±»å‹)
    m = re.match(r'^([A-Za-z]+?)([FGHJKMNQUVXZ])(\d{1,2})\s+(Index|Comdty)$', ticker)
    if m and m.group(2) in _BBG_MONTH_CODES:
        return m.group(1).upper()

    return None


def resolve_sector(ticker_str, underlying_str=None):
    """æ ¹æ® Wind Ticker æˆ– æ ‡çš„ç‰© è§£ææ¿å—åˆ†ç±»ã€‚

    Args:
        ticker_str: Wind Ticker
        underlying_str: æ ‡çš„ç‰©ï¼ˆå¤‡ç”¨ï¼‰

    Returns:
        str: æ¿å—åç§°ï¼ˆå¦‚ "è´µé‡‘å±"ï¼‰ï¼Œæœªè¯†åˆ«è¿”å› "å…¶ä»–"
    """
    prefix = _extract_prefix(ticker_str)
    if prefix and prefix in SECTOR_MAP:
        return SECTOR_MAP[prefix]

    # å°è¯•ä½¿ç”¨æ ‡çš„ç‰©
    if underlying_str:
        prefix = _extract_prefix(underlying_str)
        if prefix and prefix in SECTOR_MAP:
            return SECTOR_MAP[prefix]

    return "å…¶ä»–"


def resolve_region(ticker_str, underlying_str=None):
    """æ ¹æ® Wind Ticker æˆ– æ ‡çš„ç‰© è§£æå¢ƒå†…/å¢ƒå¤–ã€‚

    Args:
        ticker_str: Wind Ticker
        underlying_str: æ ‡çš„ç‰©ï¼ˆå¤‡ç”¨ï¼‰

    Returns:
        str: "å¢ƒå†…" æˆ– "å¢ƒå¤–"
    """
    def _check_region(ticker):
        if pd.isna(ticker):
            return None
        ticker = str(ticker).strip()
        if not ticker:
            return None

        # å¢ƒå†…æœŸè´§: .SHF, .DCE, .CZC, .INE, .CFE
        if re.search(r'\.(SHF|DCE|CZC|INE|CFE)$', ticker, re.IGNORECASE):
            return "å¢ƒå†…"

        # å¢ƒå¤–: .HK
        if ticker.endswith('.HK'):
            return "å¢ƒå¤–"

        # å¢ƒå¤–: Bloomberg æ ¼å¼ (XXX Index / XXX Comdty)
        if ' Index' in ticker or ' Comdty' in ticker:
            return "å¢ƒå¤–"

        # å¢ƒå¤–: Eurex æ ¼å¼ (FDAX2603, FGBL2603)
        if re.match(r'^(FDAX|FGBL)\d{4}$', ticker):
            return "å¢ƒå¤–"

        # å¢ƒå†… ETF: .SH, .SZ
        if re.search(r'\.(SH|SZ)$', ticker, re.IGNORECASE):
            return "å¢ƒå†…"

        return None

    region = _check_region(ticker_str)
    if region:
        return region

    if underlying_str:
        region = _check_region(underlying_str)
        if region:
            return region

    return "å¢ƒå†…"  # é»˜è®¤å¢ƒå†…
